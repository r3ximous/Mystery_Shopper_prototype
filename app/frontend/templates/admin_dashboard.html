{% extends 'base.html' %}
{% block content %}
<h2>Admin Dashboard</h2>
<div class="metric-grid" id="metricGrid">
  <div class="metric"><h4>Total Submissions</h4><div class="value" id="m-total">0</div><small>All time</small></div>
  <div class="metric"><h4>Average Score</h4><div class="value" id="m-avg">-</div><small>Weighted</small></div>
  <div class="metric"><h4>Channels</h4><div class="value" id="m-channels">0</div><small>Active</small></div>
</div>

<!-- Section Scores -->
<div class="card" style="margin-top:1.4rem;">
  <h3 style="margin-top:0;font-size:1rem;letter-spacing:.5px;">Section Performance Analysis</h3>
  <div class="section-scores" id="sectionScores">
    <!-- Section scores will be populated here -->
  </div>
</div>

<!-- Channel Breakdown -->
<div class="card" style="margin-top:1.4rem;">
  <h3 style="margin-top:0;font-size:1rem;letter-spacing:.5px;">Channel Performance</h3>
  <div class="channel-breakdown" id="channelBreakdown">
    <!-- Channel scores will be populated here -->
  </div>
</div>

<!-- Recent Submissions -->
<div class="card" style="margin-top:1.4rem;">
  <h3 style="margin-top:0;font-size:1rem;letter-spacing:.5px;">Recent Submissions</h3>
  <div class="table-wrap">
    <table id="subs">
      <thead>
        <tr>
          <th>ID</th>
          <th>Channel</th>
          <th>Location</th>
          <th>Shopper</th>
          <th>Visit Date</th>
          <th>Overall Score</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Detailed Score Modal -->
<div id="scoreModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Detailed Submission Score</h3>
      <button class="close-btn" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Detailed scores will be loaded here -->
    </div>
  </div>
</div>

<style>
.metric-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.metric {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 1.5rem;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow);
  text-align: center;
}

.metric h4 {
  margin: 0 0 0.5rem 0;
  color: var(--text-dim);
  font-size: 0.9rem;
  font-weight: normal;
}

.metric .value {
  font-size: 2rem;
  font-weight: bold;
  color: var(--accent);
  margin: 0.5rem 0;
}

.metric small {
  color: var(--text-dim);
  font-size: 0.8rem;
}

.section-scores {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.section-item {
  padding: 1rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-alt);
}

.section-name {
  font-weight: bold;
  margin-bottom: 0.5rem;
  display: flex;
  justify-content: space-between;
  color: var(--text);
}

.section-weight {
  font-size: 0.8rem;
  color: var(--text-dim);
}

.progress-bar {
  background: var(--border);
  height: 8px;
  border-radius: var(--radius-sm);
  margin: 0.5rem 0;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--accent-grad);
  transition: width 0.3s ease;
}

.section-score-text {
  font-size: 0.8rem;
  color: var(--text-dim);
  display: flex;
  justify-content: space-between;
}

.channel-breakdown {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.channel-item {
  padding: 1rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-alt);
  text-align: center;
}

.channel-name {
  font-weight: bold;
  margin-bottom: 0.5rem;
  color: var(--text);
}

.channel-score {
  font-size: 1.5rem;
  color: var(--accent);
}

.table-wrap {
  overflow-x: auto;
  margin-top: 1rem;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}

th {
  background: var(--bg-alt);
  font-weight: bold;
  color: var(--text-dim);
}

.pill {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  background: var(--accent);
  color: white;
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
}

.btn-small {
  padding: 0.25rem 0.5rem;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
  cursor: pointer;
  text-decoration: none;
}

.btn-small:hover {
  filter: brightness(1.1);
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
}

.modal-content {
  position: relative;
  background: var(--card);
  margin: 5% auto;
  padding: 0;
  width: 80%;
  max-width: 800px;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  background: var(--bg-alt);
}

.modal-header h3 {
  color: var(--text);
  margin: 0;
}

.modal-body {
  padding: 1rem;
  max-height: 60vh;
  overflow-y: auto;
  color: var(--text);
}

.close-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--text-dim);
}
</style>

<script>
async function loadDashboard() {
    try {
        const response = await fetch('/api/admin/metrics', {
            headers: {
                'X-API-Key': 'dev-admin-key'
            }
        });
        const data = await response.json();
        
        // Update metrics
        document.getElementById('m-total').textContent = data.total_submissions || 0;
        document.getElementById('m-avg').textContent = data.average_score ? `${(data.average_score * 100).toFixed(1)}%` : '-';
        document.getElementById('m-channels').textContent = data.active_channels || 0;
        
        // Update section scores
        updateSectionScores(data.section_breakdown || {});
        
        // Update channel breakdown
        updateChannelBreakdown(data.channel_breakdown || {});
        
        // Load recent submissions
        loadSubmissions();
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

function updateSectionScores(sectionScores) {
    const container = document.getElementById('sectionScores');
    container.innerHTML = '';
    
    const sectionWeights = {
        'Appearance': 5,
        'Service accessibility': 15,
        'Professionalism': 20,
        'Speed': 20,
        'Ease of use': 20,
        'Service information quality': 15,
        'Customer privacy': 5
    };
    
    Object.entries(sectionScores).forEach(([section, score]) => {
        const weight = sectionWeights[section] || 0;
        const percentage = score.toFixed(1);
        
        const sectionElement = document.createElement('div');
        sectionElement.className = 'section-item';
        sectionElement.innerHTML = `
            <div class="section-name">
                <span>${section}</span>
                <span class="section-weight">${weight}%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
            </div>
            <div class="section-score-text">
                <span>Score</span>
                <span>${percentage}%</span>
            </div>
        `;
        container.appendChild(sectionElement);
    });
}

function updateChannelBreakdown(channelSummary) {
    const container = document.getElementById('channelBreakdown');
    container.innerHTML = '';
    
    Object.entries(channelSummary).forEach(([channel, data]) => {
        const channelElement = document.createElement('div');
        channelElement.className = 'channel-item';
        channelElement.innerHTML = `
            <div class="channel-name">${channel}</div>
            <div class="channel-score">${(data.avg_score * 100).toFixed(1)}%</div>
            <small>${data.count} submissions</small>
        `;
        container.appendChild(channelElement);
    });
}

async function loadSubmissions() {
    try {
        const response = await fetch('/api/admin/submissions', {
            headers: {
                'X-API-Key': 'dev-admin-key'
            }
        });
        const submissions = await response.json();
        
        const tbody = document.querySelector('#subs tbody');
        tbody.innerHTML = '';
        
        submissions.slice(0, 10).forEach(sub => {
            const row = document.createElement('tr');
            const visitDate = new Date(sub.visit_datetime).toLocaleDateString();
            const overallScore = sub.overall_score ? `${(sub.overall_score * 100).toFixed(1)}%` : 'N/A';
            
            row.innerHTML = `
                <td>${sub.id}</td>
                <td><span class="pill">${sub.channel}</span></td>
                <td>${sub.location_code}</td>
                <td>${sub.shopper_id}</td>
                <td>${visitDate}</td>
                <td>${overallScore}</td>
                <td><button class="btn-small" onclick="showDetails(${sub.id})">Details</button></td>
            `;
            tbody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Error loading submissions:', error);
    }
}

async function showDetails(submissionId) {
    try {
        // First get the submission basic info
        const submissionsResponse = await fetch('/api/admin/submissions', {
            headers: {
                'X-API-Key': 'dev-admin-key'
            }
        });
        const submissions = await submissionsResponse.json();
        const submission = submissions.find(sub => sub.id === submissionId);
        
        if (!submission) {
            console.error('Submission not found');
            return;
        }
        
        // Then get the detailed scores
        const scoresResponse = await fetch(`/api/admin/submissions/${submissionId}/scores`, {
            headers: {
                'X-API-Key': 'dev-admin-key'
            }
        });
        const details = await scoresResponse.json();
        
        const modalBody = document.getElementById('modalBody');
        
        // Format the individual question scores
        let individualScoresHtml = '';
        if (submission.scores && submission.scores.length > 0) {
            individualScoresHtml = `
                <h4 style="margin-top: 1.5rem;">Individual Question Scores</h4>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0.5rem;">
                    <table style="width: 100%; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: var(--bg-alt);">
                                <th style="padding: 0.5rem;">Question ID</th>
                                <th style="padding: 0.5rem;">Score</th>
                                <th style="padding: 0.5rem;">Comment</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${submission.scores.map(score => `
                                <tr>
                                    <td style="padding: 0.5rem;">${score.question_id}</td>
                                    <td style="padding: 0.5rem;">${score.score}/5</td>
                                    <td style="padding: 0.5rem; max-width: 200px; word-wrap: break-word;">
                                        ${score.comment || '<em style="color: var(--text-dim);">No comment</em>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Format latency samples if available
        let latencyHtml = '';
        if (submission.latency_samples && submission.latency_samples.length > 0) {
            latencyHtml = `
                <h4 style="margin-top: 1.5rem;">Voice Usage Data</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                    ${submission.latency_samples.map(sample => `
                        <div style="padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius-sm); text-align: center;">
                            <strong>${sample.question_id}</strong><br>
                            <span style="color: var(--accent);">${Math.round(sample.ms)}ms</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        modalBody.innerHTML = `
            <div style="margin-bottom: 1.5rem;">
                <h4>Submission ID: ${submissionId}</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                    <div><strong>Overall Score:</strong> ${(details.overall_score * 100).toFixed(1)}%</div>
                    <div><strong>Visit Date:</strong> ${new Date(submission.visit_datetime).toLocaleDateString()}</div>
                    <div><strong>Channel:</strong> <span class="pill">${submission.channel}</span></div>
                    <div><strong>Location:</strong> ${submission.location_code}</div>
                    <div><strong>Shopper:</strong> ${submission.shopper_id}</div>
                    <div><strong>Total Questions:</strong> ${submission.scores ? submission.scores.length : 0}</div>
                </div>
            </div>
            
            <h4>Section Performance Breakdown</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin: 1rem 0;">
                ${Object.entries(details.section_scores).map(([section, data]) => {
                    const percentage = (data.score * 100).toFixed(1);
                    const weightPercent = (data.weight * 100).toFixed(0);
                    const questionsAnswered = data.raw_total > 0 ? data.raw_total : 0;
                    const maxPossible = data.raw_max;
                    
                    return `
                        <div style="padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-alt);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>${section}</strong>
                                <span style="color: var(--text-dim); font-size: 0.9rem;">Weight: ${weightPercent}%</span>
                            </div>
                            <div style="background: var(--border); height: 8px; border-radius: var(--radius-sm); margin: 0.5rem 0; overflow: hidden;">
                                <div style="height: 100%; background: var(--accent-grad); width: ${percentage}%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-dim); display: flex; justify-content: space-between;">
                                <span>Score: ${percentage}%</span>
                                <span>Questions: ${data.questions_count} (${questionsAnswered} answered)</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            ${individualScoresHtml}
            ${latencyHtml}
        `;
        
        document.getElementById('scoreModal').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading submission details:', error);
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = `
            <div style="color: var(--text-error, red); text-align: center; padding: 2rem;">
                <h4>Error Loading Details</h4>
                <p>Unable to load submission details. Please try again.</p>
                <p style="font-size: 0.9rem; color: var(--text-dim);">Error: ${error.message}</p>
            </div>
        `;
        document.getElementById('scoreModal').style.display = 'block';
    }
}

function closeModal() {
    document.getElementById('scoreModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('scoreModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}

// Load dashboard on page load
document.addEventListener('DOMContentLoaded', loadDashboard);

// Auto-refresh every 30 seconds
setInterval(loadDashboard, 30000);
</script>
{% endblock %}
