{% extends 'base.html' %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
  <h2>Submit Mystery Shopping Visit</h2>
  <div style="display: flex; gap: 0.5rem; align-items: center;">
    <span style="font-size: 0.8rem; color: var(--text-dim);">Language:</span>
    <select id="languageSelect" onchange="switchLanguage(this.value)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem;">
      <option value="en" {{ 'selected' if language == 'en' else '' }}>English</option>
      <option value="ar" {{ 'selected' if language == 'ar' else '' }}>العربية</option>
    </select>
  </div>
</div>

<div class="grid cols-2">
  <div class="card" style="grid-column:1 / -1;">
    <form id="surveyForm" class="survey">
      <div class="grid cols-2">
        <div class="label-row">
          <label><span>Channel</span>
            <select name="channel" required>
              <option value="CALL_CENTER">Call Center</option>
              <option value="ON_SITE">On Site</option>
              <option value="WEB">Web</option>
              <option value="MOBILE_APP">Mobile App</option>
            </select>
          </label>
        </div>
        <div class="label-row">
          <label><span>Location Code</span>
            <input type="text" name="location_code" placeholder="e.g., DXB-GOV-01" required maxlength="20" />
          </label>
        </div>
        <div class="label-row">
          <label><span>Shopper ID</span>
            <input type="text" name="shopper_id" placeholder="Your ID" required maxlength="20" />
          </label>
        </div>
        <div class="label-row">
          <label><span>Visit Date/Time</span>
            <input type="datetime-local" name="visit_datetime" required />
          </label>
        </div>
      </div>
      
      <fieldset>
        <legend id="scoresLegend">Experience Scores</legend>
        <div class="questions">
          {% for q in questions %}
          <div class="q-card" data-q="{{ q.id }}" data-weight="{{ q.weight }}">
            <div class="q-title">
              <span class="question-text" data-en="{{ q.text_en }}" data-ar="{{ q.text_ar or q.text_en }}">
                {% if language == 'ar' and q.text_ar %}{{ q.text_ar }}{% else %}{{ q.text_en|upper }}{% endif %}
              </span>
              <span class="badge debug-only" style="display: none;">{{ q.id }}</span>
            </div>
            <div class="stars">
              {# Render radios high -> low so row-reverse shows ascending left->right #}
              {% for i in range(5,0,-1) %}
                <input id="{{ q.id }}_{{ i }}" type="radio" name="{{ q.id }}" value="{{ i }}" required />
                <label for="{{ q.id }}_{{ i }}" title="{{ q.text_en }}: {{ i }} star{{ 's' if i>1 }}">★</label>
              {% endfor %}
            </div>
            {% if q.weight != 1.0 %}
            <div class="weight-indicator debug-only" style="display: none;">Weight: {{ q.weight }}x</div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </fieldset>
      
      <div class="inline-actions voice-block" style="margin-top:.5rem;">
        <div class="voice-controls">
          <button type="submit">Submit</button>
          <button type="reset" id="resetBtn" class="secondary-btn">Reset</button>
          <button type="button" id="voiceBtn" data-mode="off" class="secondary-btn">Voice Mode</button>
          <button type="button" id="langBtn" aria-pressed="false" class="secondary-btn" title="Toggle Arabic">AR</button>
          <span id="asrSpinner" class="spinner" aria-hidden="true"></span>
          <span id="cpuLoad" class="cpu-load" style="display:none;"></span>
        </div>
        <div class="voice-status-group">
          <div class="status-line">
            <span id="voiceStatus" class="voice-status" aria-live="polite">Voice idle</span>
            <span id="voiceProgress" class="voice-progress"></span>
            <span id="latencyStats" class="voice-progress"></span>
          </div>
          <div class="partials-line" style="display:none;"></div>
        </div>
      </div>
    </form>
    <pre id="result" class="result-box" style="margin-top:1rem; max-height:200px; overflow:auto;"></pre>
  </div>
</div>

<script>
// Inject survey questions from backend (backward compatibility)
window.__SURVEY_QUESTIONS = JSON.parse(decodeURIComponent("{{ questions|tojson|urlencode }}"));

// Pass current language to external scripts
window.__CURRENT_LANGUAGE = '{{ language }}';
</script>

<script src="/static/js/survey_form.js"></script>
<script type="module" src="/static/js/survey_main.js"></script>
{% endblock %}